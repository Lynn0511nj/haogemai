# 图片自动压缩功能说明

## 功能概述

为了确保图片能够成功上传并快速处理，我们添加了智能图片压缩功能。

## 压缩策略

### 1. 文件大小限制
- **上传限制**: 10MB（从原来的 5MB 提升）
- **目标大小**: 压缩后不超过 1MB

### 2. 尺寸压缩
- **最大尺寸**: 长边不超过 1920px
- **保持比例**: 自动计算并保持原始宽高比
- **智能缩放**: 
  - 如果宽度 > 高度，以宽度为基准缩放
  - 如果高度 > 宽度，以高度为基准缩放

### 3. 质量压缩
- **初始质量**: 85%（JPEG 格式）
- **动态调整**: 如果压缩后仍大于 1MB，自动降低质量
- **最低质量**: 50%（确保图片仍然清晰可读）
- **质量步进**: 每次降低 5%

## 压缩流程

1. **文件验证**: 检查文件大小是否超过 10MB
2. **图片加载**: 将图片加载到内存
3. **尺寸计算**: 根据原始尺寸计算压缩后的尺寸
4. **Canvas 绘制**: 使用 Canvas API 重新绘制图片
5. **质量优化**: 
   - 首次以 85% 质量转换为 JPEG
   - 如果仍大于 1MB，逐步降低质量
   - 直到小于 1MB 或达到最低质量 50%
6. **输出结果**: 返回压缩后的 base64 编码图片

## 技术实现

### 使用的 API
- `FileReader`: 读取文件内容
- `Image`: 加载图片
- `Canvas`: 重新绘制和压缩图片
- `canvas.toDataURL()`: 转换为 base64 格式

### 格式转换
- 所有图片统一转换为 **JPEG 格式**
- JPEG 格式支持质量参数，压缩效果更好
- 适合照片和截图类型的图片

## 用户体验

### 透明处理
- 用户无需手动压缩图片
- 自动在后台完成压缩
- 压缩过程快速，几乎无感知

### 控制台日志
开发环境下会输出压缩信息：
```
图片压缩完成: 原始大小 2048KB, 压缩后 856KB, 质量 85%
```

## 性能优化

### 压缩效果
- **典型场景**: 3MB 的截图 → 约 500-800KB
- **压缩比**: 通常可以减少 60-80% 的大小
- **质量保证**: 压缩后图片仍然清晰，适合 AI 分析

### 上传速度
- 压缩后的图片更小，上传更快
- 减少网络传输时间
- 降低服务器存储压力

## 兼容性

- ✅ 支持所有现代浏览器
- ✅ 支持移动端浏览器
- ✅ 支持各种图片格式（PNG, JPEG, WebP 等）
- ✅ 自动转换为 JPEG 格式输出

## 注意事项

1. **透明背景**: PNG 图片的透明背景会被转换为白色背景
2. **动图**: GIF 动图会被转换为静态 JPEG 图片（第一帧）
3. **质量平衡**: 在文件大小和图片质量之间取得平衡
4. **内存使用**: 大图片压缩时会占用一定内存，但处理完成后会自动释放
