# ğŸ”§ è±†åŒ… API 401 é”™è¯¯ä¿®å¤æ€»ç»“

## ğŸ“‹ é—®é¢˜æè¿°

**åŸå§‹é—®é¢˜**ï¼š
- å‰ç«¯ç›´æ¥è°ƒç”¨ `https://ark.cn-beijing.volces.com/api/v3/chat/completions`
- ä½¿ç”¨ Bearer Token é‰´æƒæ–¹å¼
- è¿”å› `401 Unauthorized - Invalid API key`

**æ ¹æœ¬åŸå› **ï¼š
- è±†åŒ…ï¼ˆç«å±±å¼•æ“ Arkï¼‰API ä¸æ”¯æŒå‰ç«¯ç›´è¿
- ä¸æ”¯æŒç®€å•çš„ Bearer Token é‰´æƒ
- å¿…é¡»ä½¿ç”¨ AccessKey + SecretKey + HMAC-SHA256 ç­¾å
- åªèƒ½åœ¨æœåŠ¡ç«¯è°ƒç”¨ï¼Œä¸èƒ½æš´éœ²å¯†é’¥åœ¨å‰ç«¯

---

## âœ… è§£å†³æ–¹æ¡ˆ

### 1. æ¶æ„è°ƒæ•´

**ä¿®å¤å‰**ï¼š
```
æµè§ˆå™¨ â†’ ç›´æ¥è°ƒç”¨è±†åŒ… API (âŒ 401 é”™è¯¯)
```

**ä¿®å¤å**ï¼š
```
æµè§ˆå™¨ â†’ æœ¬åœ° Node æœåŠ¡ç«¯ â†’ è±†åŒ… API (âœ… æ­£å¸¸å·¥ä½œ)
```

### 2. æ–°å¢æ–‡ä»¶

#### `server/index.js` - Express æœåŠ¡å™¨
- æä¾› `/api/doubao` æ¥å£ä¾›å‰ç«¯è°ƒç”¨
- å®ç° HMAC-SHA256 ç­¾åç®—æ³•
- è½¬å‘è¯·æ±‚åˆ°è±†åŒ… API
- å¤„ç†å“åº”å¹¶è¿”å›ç»™å‰ç«¯

#### `server/package.json` - æœåŠ¡ç«¯ä¾èµ–
```json
{
  "dependencies": {
    "express": "^4.18.2",
    "cors": "^2.8.5",
    "dotenv": "^16.3.1"
  }
}
```

### 3. ä¿®æ”¹æ–‡ä»¶

#### `services/geminiService.ts`
- âŒ ç§»é™¤ï¼šç›´æ¥è°ƒç”¨è±†åŒ… API çš„ä»£ç 
- âŒ ç§»é™¤ï¼šBearer Token é‰´æƒ
- âœ… æ–°å¢ï¼šè°ƒç”¨æœ¬åœ°æœåŠ¡ç«¯ `/api/doubao`
- âœ… ä¿æŒï¼šæ‰€æœ‰æ—¥å¿—å’Œé”™è¯¯å¤„ç†é€»è¾‘

#### `.env.local`
```bash
# æ—§é…ç½®ï¼ˆå·²ç§»é™¤ï¼‰
# VITE_DOUBAO_API_KEY=xxx

# æ–°é…ç½®
DOUBAO_ACCESS_KEY=ä½ çš„_Access_Key_ID
DOUBAO_SECRET_KEY=ä½ çš„_Secret_Access_Key
SERVER_PORT=3001
VITE_API_BASE_URL=http://localhost:3001
```

#### `vite-env.d.ts`
```typescript
// æ—§é…ç½®
// readonly VITE_DOUBAO_API_KEY: string

// æ–°é…ç½®
readonly VITE_API_BASE_URL: string
```

#### `package.json`
```json
{
  "scripts": {
    "server": "cd server && npm start",
    "server:dev": "cd server && npm run dev"
  }
}
```

---

## ğŸ¯ å…³é”®æ”¹è¿›

### 1. å®‰å…¨æ€§æå‡
- âœ… AccessKey/SecretKey åªåœ¨æœåŠ¡ç«¯ä½¿ç”¨
- âœ… å‰ç«¯ä»£ç ä¸åŒ…å«ä»»ä½•æ•æ„Ÿä¿¡æ¯
- âœ… ç­¾ååœ¨æœåŠ¡ç«¯ç”Ÿæˆï¼Œå‰ç«¯æ— æ³•è®¿é—®

### 2. æ¶æ„æ¸…æ™°
- âœ… å‰ç«¯åªè´Ÿè´£ UI å’Œç”¨æˆ·äº¤äº’
- âœ… æœåŠ¡ç«¯è´Ÿè´£ API é‰´æƒå’Œè°ƒç”¨
- âœ… èŒè´£åˆ†ç¦»ï¼Œæ˜“äºç»´æŠ¤

### 3. é”™è¯¯å¤„ç†
- âœ… ä¿ç•™æ‰€æœ‰è¯¦ç»†æ—¥å¿—
- âœ… æœåŠ¡ç«¯å’Œå‰ç«¯éƒ½æœ‰é”™è¯¯å¤„ç†
- âœ… å‹å¥½çš„é”™è¯¯æç¤º

---

## ğŸ“Š éªŒæ”¶æ ‡å‡†

### âœ… å·²å®Œæˆ

1. **é¡¹ç›®ç»“æ„**
   - [x] åˆ›å»º `server/` ç›®å½•
   - [x] åˆ›å»º Express æœåŠ¡å™¨
   - [x] å®ç°ç­¾åç®—æ³•
   - [x] é…ç½® CORS

2. **å‰ç«¯ä¿®æ”¹**
   - [x] ç§»é™¤ç›´æ¥ API è°ƒç”¨
   - [x] æ”¹ä¸ºè°ƒç”¨æœ¬åœ°æœåŠ¡ç«¯
   - [x] æ›´æ–°ç¯å¢ƒå˜é‡é…ç½®
   - [x] ä¿æŒæ‰€æœ‰æ—¥å¿—åŠŸèƒ½

3. **æ–‡æ¡£**
   - [x] `SETUP_GUIDE.md` - å®Œæ•´é…ç½®æŒ‡å—
   - [x] `QUICK_START.md` - å¿«é€Ÿå¯åŠ¨æŒ‡å—
   - [x] `FIX_SUMMARY.md` - æœ¬æ–‡ä»¶

4. **ä¾èµ–å®‰è£…**
   - [x] æœåŠ¡ç«¯ä¾èµ–å·²å®‰è£…
   - [x] æœåŠ¡ç«¯å·²å¯åŠ¨

### â³ å¾…å®Œæˆï¼ˆéœ€è¦ç”¨æˆ·æ“ä½œï¼‰

1. **é…ç½®å¯†é’¥**
   - [ ] è·å–è±†åŒ… AccessKey å’Œ SecretKey
   - [ ] åœ¨ `.env.local` ä¸­é…ç½®
   - [ ] é‡å¯æœåŠ¡ç«¯

2. **éªŒè¯**
   - [ ] è®¿é—® `/api/health` æ£€æŸ¥é…ç½®
   - [ ] æµ‹è¯•å®Œæ•´è¯Šæ–­æµç¨‹
   - [ ] ç¡®è®¤ä¸å†å‡ºç° 401 é”™è¯¯

---

## ğŸš€ å¯åŠ¨æ­¥éª¤

### ç»ˆç«¯ 1ï¼šå¯åŠ¨æœåŠ¡ç«¯
```bash
npm run server
```

æœŸæœ›è¾“å‡ºï¼š
```
ğŸš€ æœåŠ¡å™¨è¿è¡Œåœ¨ http://localhost:3001
ğŸ“‹ ç¯å¢ƒå˜é‡çŠ¶æ€:
   - ACCESS_KEY: âœ… å·²é…ç½®
   - SECRET_KEY: âœ… å·²é…ç½®
```

### ç»ˆç«¯ 2ï¼šå¯åŠ¨å‰ç«¯
```bash
npm run dev
```

æœŸæœ›è¾“å‡ºï¼š
```
VITE v6.4.1  ready in 763 ms
âœ  Local:   http://localhost:3000/
```

---

## ğŸ” éªŒè¯æ–¹æ³•

### 1. å¥åº·æ£€æŸ¥
```bash
curl http://localhost:3001/api/health
```

æœŸæœ›è¿”å›ï¼š
```json
{
  "status": "ok",
  "hasAccessKey": true,
  "hasSecretKey": true,
  "timestamp": "2024-..."
}
```

### 2. å®Œæ•´æµç¨‹æµ‹è¯•

1. æ‰“å¼€ http://localhost:3000
2. ç‚¹å‡»"å¼€å¯ä»Šæ—¥é—®è¯Š"
3. ä¸Šä¼ æˆªå›¾å¹¶å¡«å†™ä¿¡æ¯
4. ç‚¹å‡»"å¼€å§‹è¯Šæ–­"
5. æŸ¥çœ‹æµè§ˆå™¨æ§åˆ¶å°ï¼ˆF12ï¼‰

**æˆåŠŸæ ‡å¿—**ï¼š
- âœ… ä¸å†å‡ºç° 401 é”™è¯¯
- âœ… ä¸å†å‡ºç° "Invalid API key"
- âœ… è¯Šæ–­ç»“æœæ­£å¸¸æ˜¾ç¤º
- âœ… ä¸è¿›å…¥"è¯Šæ–­æš‚æ—¶æ— æ³•å®Œæˆ"çŠ¶æ€

---

## ğŸ“ˆ æŠ€æœ¯ç»†èŠ‚

### ç­¾åç®—æ³•å®ç°

```javascript
// 1. æ„å»ºè§„èŒƒè¯·æ±‚
const canonicalRequest = `${method}\n${uri}\n${query}\n${headers}\n${signedHeaders}\n${hashedPayload}`;

// 2. è®¡ç®—è¯·æ±‚å“ˆå¸Œ
const hashedCanonicalRequest = SHA256(canonicalRequest);

// 3. æ„å»ºå¾…ç­¾åå­—ç¬¦ä¸²
const stringToSign = `HMAC-SHA256\n${timestamp}\n${credentialScope}\n${hashedCanonicalRequest}`;

// 4. è®¡ç®—ç­¾å
const signature = HMAC-SHA256(kSigning, stringToSign);

// 5. æ„å»º Authorization å¤´
const authorization = `HMAC-SHA256 Credential=${accessKey}/${credentialScope}, SignedHeaders=${signedHeaders}, Signature=${signature}`;
```

### API è°ƒç”¨æµç¨‹

```javascript
// å‰ç«¯
fetch('http://localhost:3001/api/doubao', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ model, messages, ... })
})

// æœåŠ¡ç«¯
1. æ¥æ”¶å‰ç«¯è¯·æ±‚
2. ç”Ÿæˆç­¾å
3. è°ƒç”¨è±†åŒ… API
4. è¿”å›å“åº”ç»™å‰ç«¯
```

---

## ğŸ‰ ä¿®å¤å®Œæˆ

### é—®é¢˜è§£å†³
- âœ… 401 Unauthorized é”™è¯¯å·²ä¿®å¤
- âœ… å‰ç«¯ä¸å†ç›´æ¥è°ƒç”¨è±†åŒ… API
- âœ… ä½¿ç”¨æ­£ç¡®çš„ç­¾åé‰´æƒæ–¹å¼
- âœ… æ¶æ„æ¸…æ™°ï¼Œå®‰å…¨å¯é 

### ä¸‹ä¸€æ­¥
1. é…ç½®è±†åŒ… API å¯†é’¥
2. é‡å¯æœåŠ¡ç«¯
3. æµ‹è¯•å®Œæ•´æµç¨‹
4. å¼€å§‹ä½¿ç”¨ï¼

---

## ğŸ“ éœ€è¦å¸®åŠ©ï¼Ÿ

å¦‚æœé‡åˆ°é—®é¢˜ï¼š
1. æŸ¥çœ‹ `QUICK_START.md` å¿«é€Ÿå¯åŠ¨æŒ‡å—
2. æŸ¥çœ‹ `SETUP_GUIDE.md` å®Œæ•´é…ç½®æ–‡æ¡£
3. æ£€æŸ¥æœåŠ¡ç«¯ç»ˆç«¯çš„é”™è¯¯æ—¥å¿—
4. æ£€æŸ¥æµè§ˆå™¨æ§åˆ¶å°çš„é”™è¯¯æ—¥å¿—
5. è®¿é—® `/api/health` æ£€æŸ¥æœåŠ¡çŠ¶æ€

---

**ä¿®å¤å®Œæˆï¼ç°åœ¨åªéœ€è¦é…ç½®å¯†é’¥å°±å¯ä»¥ä½¿ç”¨äº†ï¼** ğŸš€
