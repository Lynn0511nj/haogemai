# 诊断速度优化说明

## 优化内容

### 1. 前端优化 (services/geminiService.ts)

#### 1.1 明确禁用流式响应
- 添加 `stream: false` 参数
- 确保获得完整响应而不是分块传输
- 减少数据处理开销

#### 1.2 添加请求超时控制
- 使用 AbortController 实现60秒超时
- 避免无限等待导致的用户体验问题
- 超时后返回友好的错误提示

#### 1.3 优化错误处理
- 区分超时错误和其他网络错误
- 提供更精确的错误信息
- 帮助快速定位问题

### 2. 后端优化 (server/index.js)

#### 2.1 添加性能监控
- 记录每个请求的开始时间
- 输出 API 调用耗时
- 便于性能分析和问题排查

#### 2.2 优化 HTTP 连接
- 添加 `Connection: keep-alive` 头
- 复用 TCP 连接，减少握手时间
- 降低网络延迟

#### 2.3 服务端超时控制
- 设置55秒超时（略小于前端60秒）
- 确保服务端先于前端超时
- 返回明确的超时错误状态码 (504)

## 性能提升预期

1. **网络层面**: keep-alive 可减少 20-50ms 的连接建立时间
2. **错误处理**: 超时控制避免无限等待，最多60秒返回结果
3. **监控改进**: 性能日志帮助识别瓶颈

## 注意事项

### 主要性能瓶颈
诊断速度主要取决于：
1. **AI 模型响应时间**: 这是最大的瓶颈（通常 10-30 秒）
2. **图片大小**: 较大的图片会增加上传和处理时间
3. **网络质量**: 用户网络速度影响请求传输

### 进一步优化建议
如需更快的响应速度，可以考虑：
1. 使用更快的 AI 模型（如果可用）
2. 压缩图片大小（前端上传前压缩）
3. 简化 prompt 内容（减少 token 数量）
4. 使用 CDN 加速静态资源
